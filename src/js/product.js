// Mock Data Produk - Hanya produk yang sesuai dengan gambar promosi
const products = [
  {
    id: 1,
    name: "Smart IP Indoor Camera PTZ + AI Auto Tracking",
    category: "Keamanan Pintar",
    subcategory: "Smart CCTV Indoor",
    image: "/assets/Rabit_indoor_camera.jpeg",
    price: "Rp399.000",
    specs: [
      "Resolusi: 1080P Full HD (2MP)",
      "Pan & Tilt: 355° horizontal, 90° vertikal",
      "AI Auto Tracking",
      "Night Vision hingga 10m",
      "Audio 2-way",
      "SD Card & Cloud Storage Support",
      "Chipset Terbaik Jaminan",
      "BLE Bluetooth + WiFi",
    ],
    package:
      "1 x Smart IP Camera Indoor PTZ X, 1 x Power Adapter, 1 x Mounting Kit, 1 x Quick Guide",
    warranty: "Garansi 18 Bulan - Garansi Seumur Hidup",
    description: {
      title: "Smart IP Indoor Camera PTZ + AI Auto Tracking",
      subtitle:
        "Keamanan Pintar. Otomatisasi. Powered by Tuya - Ekosistem Smart Home dan IoT global yang terdepan.",
      intro:
        "FITUR LENGKAP. HARGA BESTIE.\n\nKamera indoor pintar dengan AI Auto Tracking yang secara otomatis melacak pergerakan. Dilengkapi dengan SD Card & Cloud Storage untuk penyimpanan video maksimal.",
      features: [
        {
          title: "AI Auto Tracking",
          desc: "Kamera secara otomatis melacak dan mengikuti pergerakan objek dengan teknologi AI canggih.",
        },
        {
          title: "Pan & Tilt 355°",
          desc: "Kontrol penuh dengan rotasi horizontal 355° dan vertikal 90° untuk cakupan maksimal.",
        },
        {
          title: "1080P Full HD",
          desc: "Resolusi 2MP memberikan gambar jernih dan detail untuk keamanan 24/7.",
        },
        {
          title: "Night Vision",
          desc: "Penglihatan malam dengan jarak hingga 10 meter untuk keamanan sepanjang waktu.",
        },
        {
          title: "Audio 2-Way",
          desc: "Berkomunikasi langsung melalui kamera dengan audio 2 arah yang jernih.",
        },
        {
          title: "SD Card & Cloud Storage",
          desc: "Dukungan penyimpanan ganda dengan SD Card hingga 128GB dan Cloud Storage.",
        },
      ],
    },
  },
  {
    id: 2,
    name: "Smart IP Outdoor Camera PTZ + Dual Lens",
    category: "Keamanan Pintar",
    subcategory: "Smart CCTV Outdoor",
    image: "/assets/rabit_outdorr.jpeg",
    price: "Rp 1.700.000",
    specs: [
      "Resolusi: 1080P Full HD (2x 2MP)",
      "Dual Lens untuk jangkauan maksimal",
      "Pan & Tilt PTZ",
      "Night Vision dengan Spotlight",
      "Waterproof IP66",
      "Motion Detection",
      "SD Card & Cloud Storage Support",
      "Chipset Terbaik Jaminan",
    ],
    package:
      "1 x Smart IP Outdoor Camera PTZ Dual Lens, 1 x Power Adapter, 1 x Mounting Kit, 1 x Quick Guide",
    warranty: "Garansi 12 Bulan - Garansi Seumur Hidup",
    description: {
      title: "Smart IP Outdoor Camera PTZ + Dual Lens",
      subtitle:
        "DUA LENSA. JAGA MAKSIMAL. Keamanan Pintar. Otomatisasi. Powered by Tuya",
      intro:
        "FITUR LENGKAP. HARGA BESTIE.\n\nKamera outdoor dengan dual lens 2x 2MP untuk cakupan area yang lebih luas. Dilengkapi spotlight untuk night vision optimal dan tahan cuaca ekstrem.",
      features: [
        {
          title: "Dual Lens 2x 2MP",
          desc: "Dua lensa dengan resolusi 2MP masing-masing memberikan cakupan area maksimal tanpa blind spot.",
        },
        {
          title: "PTZ Pan & Tilt",
          desc: "Kontrol penuh rotasi kamera untuk memantau seluruh area outdoor.",
        },
        {
          title: "Night Vision + Spotlight",
          desc: "Penglihatan malam dengan spotlight terintegrasi untuk gambar berwarna di malam hari.",
        },
        {
          title: "Weatherproof IP66",
          desc: "Tahan air dan debu, cocok untuk kondisi cuaca ekstrem outdoor Indonesia.",
        },
        {
          title: "SD Card & Cloud Storage",
          desc: "Penyimpanan ganda dengan SD Card hingga 128GB dan backup cloud otomatis.",
        },
      ],
    },
  },
  {
    id: 3,
    name: "Smart Door Lock EZY + Ultra-Fast Fingerprint",
    category: "Keamanan Pintar",
    subcategory: "Smart Door Lock",
    image: "/assets/doorlock.jpeg",
    price: "Rp 13.000.000",
    specs: [
      "Ultra-Fast Fingerprint Sensor",
      "Fingerprint Capacity: 100",
      "Password: 4-12 digits",
      "RFID Card Support",
      "Auto-locks Electric",
      "Lock and Unlock History",
      "5 Ways to Unlock",
      "Energy USB Type-C",
      "Emergency Power: Micro USB",
      "Battery: 4 x AA (6-12 bulan)",
      "Material: Zinc Alloy",
    ],
    package:
      "1 x Smart Door Lock EZY, 2 x RFID Card, 1 x Installation Kit, 4 x AA Battery, 1 x Quick Guide",
    warranty: "Garansi 12 Bulan + Chipset Terbaik Jaminan",
    description: {
      title: "Smart Door Lock EZY + Ultra-Fast Fingerprint",
      subtitle:
        "CEPAT. AMAN. NYAMAN. Keamanan Pintar. Otomatisasi. Powered by Tuya",
      intro:
        "Kunci pintu pintar dengan sensor sidik jari ultra-cepat dan 5 metode akses untuk keamanan maksimal keluarga Anda.",
      features: [
        {
          title: "Ultra-Fast Fingerprint Sensor",
          desc: "Sensor sidik jari generasi terbaru yang sangat cepat dan akurat dalam 0.3 detik.",
        },
        {
          title: "Auto-locks Electric",
          desc: "Kunci otomatis mengunci pintu secara elektrik setelah pintu ditutup untuk keamanan maksimal.",
        },
        {
          title: "5 Ways to Unlock",
          desc: "Buka dengan sidik jari, password, RFID card, kunci mekanis, atau smartphone app.",
        },
        {
          title: "Lock and Unlock History",
          desc: "Pantau riwayat keluar masuk lengkap dengan waktu dan metode akses via aplikasi.",
        },
        {
          title: "Protect+ Security",
          desc: "Teknologi enkripsi tingkat bank dengan perlindungan anti-peeping password.",
        },
        {
          title: "Energy USB Type-C",
          desc: "Charging emergency via USB Type-C ketika baterai habis.",
        },
      ],
    },
  },
  {
    id: 4,
    name: "Storage SD Card Rabit Legend Series 64GB",
    category: "Penyimpanan Video",
    subcategory: "SD Card Storage",
    image: "/assets/sd_card64.jpeg",
    price: "Rp 149.000",
    specs: [
      "Kapasitas: 64GB",
      "Kecepatan: hingga 100 Mb/s",
      "Class: V30 U3 A1",
      "Type: XC (SDXC)",
      "Optimasi untuk IP Camera",
      "Garansi Seumur Hidup",
      "Compatible dengan semua device",
    ],
    package: "1 x Rabit SD Card Legend Series 64GB",
    warranty: "Garansi Seumur Hidup",
    description: {
      title: "SD Card Legend Series 64GB - Smart IP Camera Storage",
      subtitle:
        "Rabit LEGEND - Di optimasi untuk performa IP Camera. Kecepatan hingga 100 Mb/s",
      intro:
        "SD Card berkualitas premium yang dioptimalkan khusus untuk IP Camera dengan kecepatan tinggi dan garansi seumur hidup.",
      features: [
        {
          title: "Optimasi IP Camera",
          desc: "Dirancang khusus untuk recording IP Camera 24/7 dengan performa stabil.",
        },
        {
          title: "Kecepatan Tinggi 100 Mb/s",
          desc: "Transfer data cepat hingga 100 Mb/s untuk recording Full HD tanpa lag.",
        },
        {
          title: "V30 U3 A1 Class",
          desc: "Class premium untuk performa maksimal dan durability tinggi.",
        },
        {
          title: "Garansi Seumur Hidup",
          desc: "Jaminan kualitas dengan garansi seumur hidup untuk ketenangan Anda.",
        },
      ],
    },
  },
  {
    id: 5,
    name: "Storage SD Card Rabit Legend Series 128GB",
    category: "Penyimpanan Video",
    subcategory: "SD Card Storage",
    image: "/assets/sd_card128.jpeg",
    price: "Rp 249.000",
    specs: [
      "Kapasitas: 128GB",
      "Kecepatan: hingga 100 Mb/s",
      "Class: V30 U3 A1",
      "Type: XC (SDXC)",
      "Optimasi untuk IP Camera",
      "Garansi Seumur Hidup",
      "Compatible dengan semua device",
    ],
    package: "1 x Rabit SD Card Legend Series 128GB",
    warranty: "Garansi Seumur Hidup",
    description: {
      title: "SD Card Legend Series 128GB - Smart IP Camera Storage",
      subtitle:
        "Rabit LEGEND - Di optimasi untuk performa IP Camera. Kecepatan hingga 100 Mb/s",
      intro:
        "SD Card kapasitas besar 128GB untuk recording lebih lama dengan kualitas premium dan garansi seumur hidup.",
      features: [
        {
          title: "Kapasitas Besar 128GB",
          desc: "Penyimpanan lebih besar untuk recording lebih lama hingga berminggu-minggu.",
        },
        {
          title: "Optimasi IP Camera",
          desc: "Dirancang khusus untuk recording IP Camera 24/7 dengan performa stabil.",
        },
        {
          title: "Kecepatan Tinggi 100 Mb/s",
          desc: "Transfer data cepat hingga 100 Mb/s untuk recording Full HD tanpa lag.",
        },
        {
          title: "Garansi Seumur Hidup",
          desc: "Jaminan kualitas dengan garansi seumur hidup untuk ketenangan Anda.",
        },
      ],
    },
  },
];

// State management
// State management
let currentFilter = {
  category: null,
  subcategory: null,
};

// Initialize page
function init() {
  console.log("Initializing product page...");
  console.log("Total products:", products.length);

  // Check URL parameters
  checkUrlParameters();

  renderProducts(products);
  setupEventListeners();
}

// Check URL parameters for category filtering
function checkUrlParameters() {
  const urlParams = new URLSearchParams(window.location.search);
  const categoryParam = urlParams.get("category");

  if (categoryParam) {
    console.log("URL category parameter found:", categoryParam);

    // Handle category parameter
    if (categoryParam === "keamanan") {
      setTimeout(() => {
        expandKeamananCategory();
        filterByCategory("Keamanan Pintar");
      }, 100);
    } else if (categoryParam === "penyimpanan") {
      setTimeout(() => {
        expandPenyimpananCategory();
        filterByCategory("Penyimpanan Video");
      }, 100);
    }
  }
}

// Expand Keamanan Pintar category in sidebar
function expandKeamananCategory() {
  console.log("Expanding Keamanan Pintar category");
  const element = document.getElementById("cat-keamanan");
  const icon = document.getElementById("icon-keamanan");

  if (element && icon) {
    element.classList.remove("hidden");
    icon.classList.add("rotate-180");
    console.log("Keamanan category expanded");
  }
}

// Expand Penyimpanan Video category in sidebar
function expandPenyimpananCategory() {
  console.log("Expanding Penyimpanan Video category");
  const element = document.getElementById("cat-penyimpanan");
  const icon = document.getElementById("icon-penyimpanan");

  if (element && icon) {
    element.classList.remove("hidden");
    icon.classList.add("rotate-180");
    console.log("Penyimpanan category expanded");
  }
}

// Handle click on "Penyimpanan Video" category link itself
function handlePenyimpananVideoClick() {
  console.log("Penyimpanan Video clicked");
  filterByCategory("Penyimpanan Video");
}

// Filter products by main category
function filterByCategory(category) {
  console.log("Filtering by main category:", category);
  currentFilter.category = category;
  currentFilter.subcategory = null;

  // Update title
  const categoryTitle = document.getElementById("categoryTitle");
  if (categoryTitle) {
    categoryTitle.textContent = category;
  }

  // Filter and render products
  const filtered = products.filter((p) => p.category === category);
  console.log("Filtered products count:", filtered.length);
  renderProducts(filtered);

  // Reset subcategory active states
  document.querySelectorAll(".subcategory-link").forEach((link) => {
    link.classList.remove("text-orange-600", "font-semibold");
    link.classList.add("text-gray-600");
  });
}

// Setup all event listeners
function setupEventListeners() {
  console.log("Setting up event listeners...");

  // Category toggle buttons
  const categoryButtons = document.querySelectorAll("[data-category]");
  console.log("Found category buttons:", categoryButtons.length);

  categoryButtons.forEach((btn) => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const categoryId = this.getAttribute("data-category");
      console.log("Toggle category clicked:", categoryId);
      toggleCategory(categoryId);
    });
  });

  // Subcategory filter links
  const subcategoryLinks = document.querySelectorAll("[data-subcategory]");
  console.log("Found subcategory links:", subcategoryLinks.length);

  subcategoryLinks.forEach((link) => {
    link.addEventListener("click", function (e) {
      e.preventDefault();
      const subcategory = this.getAttribute("data-subcategory");
      console.log("Filter by subcategory clicked:", subcategory);
      filterBySubcategory(subcategory);
    });
  });

  // Handle "Penyimpanan Video" text link (hijau)
  const penyimpananLinks = document.querySelectorAll(
    'a[href*="penyimpanan"], .category-link'
  );
  penyimpananLinks.forEach((link) => {
    const linkText = link.textContent.trim();
    if (linkText === "Penyimpanan Video") {
      link.addEventListener("click", function (e) {
        e.preventDefault();
        console.log("Penyimpanan Video link clicked");
        filterByCategory("Penyimpanan Video");
      });
    }
  });

  // Show all products button
  const showAllBtn = document.getElementById("showAllBtn");
  if (showAllBtn) {
    console.log("Show all button found");
    showAllBtn.addEventListener("click", function (e) {
      e.preventDefault();
      console.log("Show all products clicked");
      showAllProducts();
    });
  }

  // Modal close button
  const modalCloseBtn = document.getElementById("closeModalBtn");
  if (modalCloseBtn) {
    modalCloseBtn.addEventListener("click", function (e) {
      e.preventDefault();
      closeModal();
    });
  }

  // Modal backdrop click
  const modal = document.getElementById("productModal");
  if (modal) {
    modal.addEventListener("click", function (e) {
      if (e.target === this) {
        closeModal();
      }
    });
  }
}

// Toggle category visibility
function toggleCategory(categoryId) {
  console.log("Toggling category:", categoryId);
  const element = document.getElementById(`cat-${categoryId}`);
  const icon = document.getElementById(`icon-${categoryId}`);

  if (element && icon) {
    element.classList.toggle("hidden");
    icon.classList.toggle("rotate-180");
    console.log("Category toggled successfully");
  } else {
    console.error("Category element or icon not found:", categoryId);
  }
}

// Filter products by subcategory
function filterBySubcategory(subcategory) {
  console.log("Filtering by subcategory:", subcategory);
  currentFilter.subcategory = subcategory;

  // Update active state in sidebar
  document.querySelectorAll(".subcategory-link").forEach((link) => {
    link.classList.remove("text-orange-600", "font-semibold");
    link.classList.add("text-gray-600");
  });

  // Find and highlight active link
  const activeLink = Array.from(
    document.querySelectorAll(".subcategory-link")
  ).find((link) => link.getAttribute("data-subcategory") === subcategory);

  if (activeLink) {
    activeLink.classList.remove("text-gray-600");
    activeLink.classList.add("text-orange-600", "font-semibold");
    console.log("Active link highlighted");
  }

  // Update title
  const categoryTitle = document.getElementById("categoryTitle");
  if (categoryTitle) {
    categoryTitle.textContent = subcategory;
  }

  // Filter and render products
  const filtered = products.filter((p) => p.subcategory === subcategory);
  console.log("Filtered products count:", filtered.length);
  renderProducts(filtered);
}

// Show all products
function showAllProducts() {
  console.log("Showing all products");
  currentFilter = {
    category: null,
    subcategory: null,
  };

  // Reset active states
  document.querySelectorAll(".subcategory-link").forEach((link) => {
    link.classList.remove("text-orange-600", "font-semibold");
    link.classList.add("text-gray-600");
  });

  // Update title
  const categoryTitle = document.getElementById("categoryTitle");
  if (categoryTitle) {
    categoryTitle.textContent = "Semua Produk";
  }

  renderProducts(products);
}

// Render products to grid
function renderProducts(productsToRender) {
  console.log("Rendering products, count:", productsToRender.length);
  const grid = document.getElementById("productsGrid");

  if (!grid) {
    console.error("Products grid element not found!");
    return;
  }

  grid.innerHTML = "";

  if (productsToRender.length === 0) {
    grid.innerHTML = `
      <div class="col-span-full text-center py-12">
        <p class="text-gray-500 text-lg">Tidak ada produk ditemukan</p>
      </div>
    `;
    return;
  }

  productsToRender.forEach((product) => {
    const card = document.createElement("div");
    card.className =
      "bg-white rounded-lg shadow product-card cursor-pointer overflow-hidden hover:shadow-lg transition";

    // Navigate to detail page with product ID
    card.onclick = () => {
      window.location.href = `/productDetail.html?id=${product.id}`;
    };

    card.innerHTML = `
      <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
      <div class="p-4">
        <p class="text-xs text-gray-500 uppercase mb-1">${product.subcategory}</p>
        <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2 h-12">${product.name}</h3>
        <p class="text-orange-600 font-bold text-lg mb-2">${product.price}</p>
        <button class="text-orange-600 text-sm font-medium hover:text-orange-700">
          Lihat Detail →
        </button>
      </div>
    `;

    grid.appendChild(card);
  });

  console.log(`Successfully rendered ${productsToRender.length} products`);
}

// Show product detail in modal
function showProductDetail(product) {
  console.log("Showing product detail:", product.name);
  const modalTitle = document.getElementById("modalTitle");
  const modalImage = document.getElementById("modalImage");
  const modalSpecs = document.getElementById("modalSpecs");
  const modalPackage = document.getElementById("modalPackage");
  const modalWarranty = document.getElementById("modalWarranty");
  const modalDescription = document.getElementById("modalDescription");
  const modal = document.getElementById("productModal");

  if (!modal) {
    console.error("Modal not found!");
    return;
  }

  modalTitle.textContent = product.name;
  modalImage.src = product.image;
  modalImage.alt = product.name;

  // Specs
  const specsHtml = product.specs
    .map(
      (spec) =>
        `<div class="flex items-start">
          <span class="text-gray-600">• ${spec}</span>
        </div>`
    )
    .join("");
  modalSpecs.innerHTML = specsHtml;

  // Package
  modalPackage.textContent = product.package;

  // Warranty
  modalWarranty.textContent = product.warranty;

  // Description
  let descHtml = `
    <h4 class="font-bold text-xl mb-2">${product.description.title}</h4>
    <p class="text-gray-600 mb-4">${product.description.subtitle}</p>
  `;

  if (product.description.intro) {
    const introLines = product.description.intro.split("\n");
    descHtml += introLines
      .map((line) => `<p class="mb-3">${line}</p>`)
      .join("");
  }

  product.description.features.forEach((feature) => {
    descHtml += `
      <div class="mb-4">
        <h5 class="font-semibold mb-1">${feature.title}</h5>
        <p class="text-gray-700">${feature.desc}</p>
      </div>
    `;
  });

  modalDescription.innerHTML = descHtml;

  modal.classList.remove("hidden");
  console.log("Modal displayed");
}

// Close modal
function closeModal() {
  console.log("Closing modal");
  const modal = document.getElementById("productModal");
  if (modal) {
    modal.classList.add("hidden");
  }
}

// Initialize when DOM is ready
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}

console.log("Product.js loaded successfully");
